<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heitian.ssm.dao.ProductCommentDao">

    <resultMap id="ProductCommentBaseMap" type="com.heitian.ssm.model.ProductComment">
        <id column="id" property="id" />
        <result column="product_id" property="productId" />
        <result column="customer_id" property="customerId" />
        <result column="comment" property="comment"/>
        <result column="created_at" property="createdAt"/>
        <result column="order_id" property="orderId"/>
        <result column="rate" property="rate"/>
    </resultMap>

    <resultMap id="CommentBoMap" type="com.heitian.ssm.bo.ProductCommentBo">
        <result column="rate" property="rate"/>
        <result column="product_name" property="productName" />
        <result column="customer_name" property="customerName" />
        <result column="comment" property="comment"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <select id="getCommentBos" resultMap="CommentBoMap">
        SELECT
          customer.name customer_name,
          product.name product_name,
          amount,
          price/100 price,
          comment,
          product_comment.created_at,
          rate
        FROM product_comment
        JOIN customer ON customer_id=customer.id
        JOIN product ON product_comment.product_id=product.id
        WHERE product_comment.product_id=#{productId}
        ORDER BY product_comment.created_at desc
        limit #{start},#{pageNum}
    </select>

    <select id="getCommentNum" resultType="_int">
        SELECT count(*)
        FROM product_comment
        WHERE product_id=#{productId}
    </select>
    <!-- ++++++++++++ 2017.12.23++++++++++++++++++-->
    <insert id="addComment" parameterType="com.heitian.ssm.model.ProductComment">
        INSERT INTO product_comment(customer_id, product_id, order_id, comment, rate)
        VALUES (#{comment.customerId}, #{comment.productId}, #{comment.orderId}, #{comment.comment}, #{comment.rate})
    </insert>
    <select id="getCommentByPidOid" resultMap="ProductCommentBaseMap">
        SELECT *
        FROM product_comment
        WHERE product_id=#{productId} AND order_id=#{orderId}
    </select>
    <!-- +++++++++++++++-->
    <select id="getAvgRate" resultType="double">
        SELECT sum(rate)/count(*)
        FROM product_comment
        WHERE product_id=#{productId}
    </select>
</mapper>
